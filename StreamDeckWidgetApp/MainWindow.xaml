<ui:FluentWindow x:Class="StreamDeckWidgetApp.MainWindow"
                 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                 xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
                 xmlns:converters="clr-namespace:StreamDeckWidgetApp.Core.Converters"
                 xmlns:behaviors="clr-namespace:StreamDeckWidgetApp.Core.Behaviors"
                 mc:Ignorable="d"
        Title="Virtual Deck"
                 Width="{Binding WindowWidth, Mode=OneWay}"
                 Height="{Binding WindowHeight, Mode=OneWay}"
                 MinWidth="200"
                 MinHeight="200"
                 ResizeMode="NoResize"
                 Topmost="True"
                 WindowCornerPreference="Round"
                 WindowBackdropType="Mica"
                 ExtendsContentIntoTitleBar="True">

    <ui:FluentWindow.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:ImagePathToImageSourceConverter x:Key="PathToImage"/>
    </ui:FluentWindow.Resources>

    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- TitleBar -->
            <RowDefinition Height="Auto"/>
            <!-- Editor Indicator -->
            <RowDefinition Height="Auto"/>
            <!-- Deck Items - BURADA * YERINE Auto -->
        </Grid.RowDefinitions>

        <!-- WPF UI Title Bar: Sürükleme + Snap Layouts + Sistem Menüsü Desteği -->
        <ui:TitleBar Grid.Row="0"
                     Title="My Deck"
                     Height="32"
                     Margin="0,0,0,8"
                     ShowMaximize="False"
                     ShowMinimize="False"
                     ShowHelp="False">
            <ui:TitleBar.TrailingContent>
                <ui:Button Command="{Binding OpenEditorCommand}"
                           Icon="{ui:SymbolIcon Settings28}"
                           ToolTip="Settings"
                           Width="44"
                           Height="30"
                           Appearance="Transparent"
                           Background="Transparent"
                           BorderThickness="0"
                           Padding="0"
                           Margin="0,0,0,0"
                           >
                   
                </ui:Button>
            </ui:TitleBar.TrailingContent>
        </ui:TitleBar>

        <!-- Editör durumu göstergesi -->
        <Border Grid.Row="1"
                Height="3"
                Margin="-8,0,-8,8"
                Background="{DynamicResource AccentFillColorDefaultBrush}">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Visibility"
                            Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsEditorOpen}"
                                     Value="True">
                            <Setter Property="Visibility"
                                    Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>
        </Border>

        <!-- Butonlar (Deck Items) -->
        <ItemsControl Grid.Row="2"
                      ItemsSource="{Binding DeckItems}"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <UniformGrid Columns="{Binding DataContext.Columns, RelativeSource={RelativeSource AncestorType=Window}}"/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <Button Command="{Binding DataContext.ItemClickCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                            CommandParameter="{Binding}"
                            Margin="5"
                            Cursor="Hand"
                            BorderThickness="0"
                            Width="{Binding DataContext.SelectedButtonSize, RelativeSource={RelativeSource AncestorType=Window}}"
                            Height="{Binding DataContext.SelectedButtonSize, RelativeSource={RelativeSource AncestorType=Window}}">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="MainBorder"
                                                    Background="{Binding Color}"
                                                    CornerRadius="8"
                                                    Padding="5"
                                                    AllowDrop="True"
                                                    Drop="Button_Drop"
                                                    BorderThickness="3"
                                                    RenderTransformOrigin="0.5,0.5">
                                                <Border.RenderTransform>
                                                    <ScaleTransform x:Name="ButtonScale"
                                                                    ScaleX="1"
                                                                    ScaleY="1"/>
                                                </Border.RenderTransform>
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Setter Property="BorderBrush"
                                                                Value="Transparent"/>
                                                        <Style.Triggers>
                                                            <!-- Seçili buton vurgusu -->
                                                            <DataTrigger Binding="{Binding IsSelected}"
                                                                         Value="True">
                                                                <Setter Property="BorderBrush"
                                                                        Value="#4CC2FF"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <Grid x:Name="ContentGrid">
                                                    <!-- Hover overlay: beyaz ile hafif parlaklık efekti verir -->
                                                    <Rectangle x:Name="HoverOverlay"
                                                               Fill="White"
                                                               Opacity="0"
                                                               IsHitTestVisible="False"
                                                               RadiusX="8"
                                                               RadiusY="8"/>

                                                    <!-- Dosya İkonu (IconPath varsa) -->
                                                    <Image Source="{Binding IconPath, Converter={StaticResource PathToImage}}"
                                                           Stretch="UniformToFill"
                                                           Opacity="0.8"/>

                                                    <!-- Segoe MDL2 / Emoji İkonu (Icon varsa) -->
                                                    <TextBlock Text="{Binding Icon}"
                                                               FontFamily="Segoe MDL2 Assets"
                                                               FontSize="32"
                                                               Foreground="White"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"
                                                               Margin="0,0,0,10"
                                                               Opacity="0.95">
                                                        <TextBlock.Effect>
                                                            <DropShadowEffect ShadowDepth="2"
                                                                              BlurRadius="5"
                                                                              Opacity="0.5"
                                                                              Color="#000"/>
                                                        </TextBlock.Effect>
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Visibility"
                                                                        Value="Visible"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding Icon}"
                                                                                 Value="">
                                                                        <Setter Property="Visibility"
                                                                                Value="Collapsed"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding Icon}"
                                                                                 Value="{x:Null}">
                                                                        <Setter Property="Visibility"
                                                                                Value="Collapsed"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>

                                                    <!-- Alt kısımda metin için gradient overlay -->
                                                    <Border VerticalAlignment="Bottom"
                                                            HorizontalAlignment="Stretch"
                                                            CornerRadius="0,0,6,6"
                                                            Padding="4,12,4,4"
                                                            Height="36">
                                                        <Border.Background>
                                                            <LinearGradientBrush StartPoint="0,0"
                                                                                 EndPoint="0,1">
                                                                <GradientStop Color="Transparent"
                                                                              Offset="0"/>
                                                                <GradientStop Color="#99000000"
                                                                              Offset="0.35"/>
                                                                <GradientStop Color="#CC000000"
                                                                              Offset="1"/>
                                                            </LinearGradientBrush>
                                                        </Border.Background>
                                                        <TextBlock Text="{Binding Title}"
                                                                   Foreground="White"
                                                                   FontWeight="Bold"
                                                                   HorizontalAlignment="Center"
                                                                   VerticalAlignment="Bottom"
                                                                   TextWrapping="NoWrap"
                                                                   TextTrimming="CharacterEllipsis"
                                                                   TextAlignment="Center">
                                                            <TextBlock.Effect>
                                                                <DropShadowEffect ShadowDepth="1"
                                                                                  BlurRadius="3"
                                                                                  Opacity="0.9"
                                                                                  Color="#000"/>
                                                            </TextBlock.Effect>
                                                        </TextBlock>
                                                    </Border>
                                                </Grid>
                                            </Border>

                                            <ControlTemplate.Triggers>
                                                <!-- Hover State: HoverOverlay opacity ile parlaklık simülasyonu -->
                                                <Trigger Property="IsMouseOver"
                                                         Value="True">
                                                    <Trigger.EnterActions>
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <DoubleAnimation Storyboard.TargetName="HoverOverlay"
                                                                                 Storyboard.TargetProperty="Opacity"
                                                                                 To="0.12"
                                                                                 Duration="0:0:0.08"/>
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </Trigger.EnterActions>
                                                    <Trigger.ExitActions>
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <DoubleAnimation Storyboard.TargetName="HoverOverlay"
                                                                                 Storyboard.TargetProperty="Opacity"
                                                                                 To="0.0"
                                                                                 Duration="0:0:0.12"/>
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </Trigger.ExitActions>
                                                </Trigger>

                                                <!-- Pressed State: Gömülme efekti (anlık) -->
                                                <Trigger Property="IsPressed"
                                                         Value="True">
                                                    <Trigger.EnterActions>
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <DoubleAnimation Storyboard.TargetName="ButtonScale"
                                                                                 Storyboard.TargetProperty="ScaleX"
                                                                                 To="0.95"
                                                                                 Duration="0:0:0.05"/>
                                                                <DoubleAnimation Storyboard.TargetName="ButtonScale"
                                                                                 Storyboard.TargetProperty="ScaleY"
                                                                                 To="0.95"
                                                                                 Duration="0:0:0.05"/>
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </Trigger.EnterActions>
                                                    <Trigger.ExitActions>
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <DoubleAnimation Storyboard.TargetName="ButtonScale"
                                                                                 Storyboard.TargetProperty="ScaleX"
                                                                                 To="1.0"
                                                                                 Duration="0:0:0.1"/>
                                                                <DoubleAnimation Storyboard.TargetName="ButtonScale"
                                                                                 Storyboard.TargetProperty="ScaleY"
                                                                                 To="1.0"
                                                                                 Duration="0:0:0.1"/>
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </Trigger.ExitActions>
                                                </Trigger>

                                                <!-- Toggle Active State: Basılı kalma efekti -->
                                                <MultiDataTrigger>
                                                    <MultiDataTrigger.Conditions>
                                                        <Condition Binding="{Binding BehaviorType}"
                                                                   Value="Toggle"/>
                                                        <Condition Binding="{Binding IsActive}"
                                                                   Value="True"/>
                                                    </MultiDataTrigger.Conditions>
                                                    <MultiDataTrigger.EnterActions>
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <DoubleAnimation Storyboard.TargetName="ButtonScale"
                                                                                 Storyboard.TargetProperty="ScaleX"
                                                                                 To="0.95"
                                                                                 Duration="0:0:0.1"/>
                                                                <DoubleAnimation Storyboard.TargetName="ButtonScale"
                                                                                 Storyboard.TargetProperty="ScaleY"
                                                                                 To="0.95"
                                                                                 Duration="0:0:0.1"/>
                                                                <DoubleAnimation Storyboard.TargetName="HoverOverlay"
                                                                                 Storyboard.TargetProperty="Opacity"
                                                                                 To="0.25"
                                                                                 Duration="0:0:0.1"/>
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </MultiDataTrigger.EnterActions>
                                                    <MultiDataTrigger.ExitActions>
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <DoubleAnimation Storyboard.TargetName="ButtonScale"
                                                                                 Storyboard.TargetProperty="ScaleX"
                                                                                 To="1.0"
                                                                                 Duration="0:0:0.1"/>
                                                                <DoubleAnimation Storyboard.TargetName="ButtonScale"
                                                                                 Storyboard.TargetProperty="ScaleY"
                                                                                 To="1.0"
                                                                                 Duration="0:0:0.1"/>
                                                                <DoubleAnimation Storyboard.TargetName="HoverOverlay"
                                                                                 Storyboard.TargetProperty="Opacity"
                                                                                 To="0.0"
                                                                                 Duration="0:0:0.1"/>
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </MultiDataTrigger.ExitActions>
                                                </MultiDataTrigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Setter Property="Cursor"
                                        Value="Hand"/>
                            </Style>
                        </Button.Style>
                    </Button>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>
    </Grid>
</ui:FluentWindow>
